(function(){$.widget("execut.DetailView",{isDebug:false,buttonsEl:null,topOffset:null,sizesEl:null,initialHtml:{},timeout:1000,_initInitialHtml:function(){var a=this;a.options.refreshedRows.forEach(function(c){var b=$(a.options.fields[c.name].rowSelector);a.initialHtml[c.name]=a._replaceNewStrings($("<div />").append(b.clone()).html())})},_replaceNewStrings:function(a){return a.replace(/(?:\r\n|\r|\n)/g,"")},_create:function(){var a=this;a._initElements();a._initEvents();a._initRefreshedRows();a._initInitialHtml()},_initRefreshedRows:function(){var c=this,e=null,a=[],d={};c.options.refreshedRows.forEach(function(i){switch(i.refreshType){case"periodically":a[a.length]=i.name;break;case"dependent":for(var g in i.watchedInputs){var h=i.watchedInputs[g];if(typeof d[h.name]==="undefined"){d[h.name]=[]}d[h.name].push(i.name)}break}});c.dependentUpdated=d;for(var b in c.dependentUpdated){c.initChangeEventForDependentElement(b)}if(a.length){var f=function(){setTimeout(function(){c.refreshPeriodicalyUpdatedAttributes(a,f)},c.timeout)};f()}},findAttributeRefreshParams:function(d,c){var a=[],b=this;b.options.refreshedRows.forEach(function(e){if(e.refreshType==c&&e.name===d){a.push(e)}});return a},refreshPeriodicalyUpdatedAttributes:function(b,d){var a=[],c=this;b.forEach(function(f){var e=c.findAttributeRefreshParams(f,"periodically"),h=false,g;e.forEach(function(i){if(i.watchedInputs.length===0){h=true}else{i.watchedInputs.forEach(function(k){var l=c.findInputEl(k.name).val();if(typeof k.values!=="undefined"&&k.values.length){for(var j in k.values){if(l==k.values[j]){h=true;g="setted values";break}}}else{if(typeof k.whenIsEmpty!=="undefined"){if(k.whenIsEmpty&&l.length===0){h=true;g="empty"}else{if(!k.whenIsEmpty&&l.length!==0){h=true;g="not empty"}}}else{h=true;g="change"}}})}});if(h&&!a.includes(f)){a.push(f)}});c.refreshAttributes(a,d)},findInputEl:function(a){var b=this,c=$(b.options.fields[a].fieldSelector);if(c.is("div")){c=c.find("input:checked")}return c},initChangeEventForDependentElement:function(b){var c=this,a=c.options.fields[b].fieldSelector;$(a).change(function(){var d=[],h=$(this).val();for(var e in c.dependentUpdated[b]){var g=false,f="not",i=c.dependentUpdated[b][e];c.options.refreshedRows.forEach(function(n){if(n.name===i){var j=n.watchedInputs;for(var k in j){var m=j[k];if(typeof m.values!=="undefined"&&m.values.length){for(var l in m.values){if(h==m.values[l]){g=true;f="setted values";break}}}else{if(typeof m.whenIsEmpty!=="undefined"){if(m.whenIsEmpty&&h.length===0){g=true;f="empty"}else{if(!m.whenIsEmpty&&h.length!==0){g=true;f="not empty"}}}else{g=true;f="change"}}if(g){return false}}}});if(g&&!d.includes(i)){d.push(i)}}c.refreshAttributes(d,null)})},refreshAttributes:function(a,f){var d=this,c=d.element.parent("form");if(!a.length){console.debug("skip");if(f){f()}return}var g={};a.forEach(function(i){if(typeof d.options.fields[i]!=="undefined"){var h=$(d.options.fields[i].fieldSelector),j=false;if(h.is("div")){j=h.parent().find("input");h=h.find("input:checked")}g[i]=h.val();if(j){j.prop("disabled",true)}h.val("-1")}});var e=c.serialize();a.forEach(function(i){if(typeof d.options.fields[i]!=="undefined"){var h=$(d.options.fields[i].fieldSelector),j=false;if(h.is("div")){j=h.parent().find("input");h=h.find("input:checked")}if(j){j.prop("disabled",false)}h.val(g[i])}});var b="";if(location.href.match(/\?/)){b="&"}else{b="?"}$.ajax({dataType:"json",url:location.href+b+jQuery.param({refreshedAttributes:a}),method:"post",data:e,success:function(h){for(var j in h.rows){var i=h.rows[j];i.html=d._replaceNewStrings($("<div />").append(i.html).html());if(i.html!==d.initialHtml[j]&&typeof d.options.fields[j]!=="undefined"){console.debug("update "+j);console.debug(i.js);console.debug("old html:",d.initialHtml[j]);console.debug("new html:",i.html);$(d.options.fields[j].rowSelector).replaceWith(i.html);d.initialHtml[j]=i.html;if(typeof i.js!=="undefined"){$(document.body).append("<script>"+i.js+"<\/script>")}if(typeof d.dependentUpdated[j]!=="undefined"){d.findInputEl(j).change();d.initChangeEventForDependentElement(j)}}}if(f){f()}},headers:{"X-Pjax":1}})},_initElements:function(){var a=this;a.formEl=a.element.parent();a.buttonsEl=a.element.find(".buttons-container");if(a.isDebug){a.sizesEl=$('<div style="display: inline-block; font-size: 6px"></div>');a.buttonsEl.prepend(a.sizesEl)}},isSaved:false,_initEvents:function(){var b=this,a=false;b.formEl.on("beforeValidate",function(f,g,c){var d=function(){b.formEl.unbind("ajaxComplete",d);if(a){b.element.loadingOverlay("remove");a=false}};b.formEl.on("ajaxComplete",d);if(!a){a=true;b.element.loadingOverlay({loadingText:"Загрузка.."})}});b.formEl.on("submit",function(d,f,c){if(!a){a=true;b.element.loadingOverlay({loadingText:"Загрузка.."})}});b.formEl.on("afterValidate",function(d,f,c){if(a){b.element.loadingOverlay("remove");a=false}});if(b.options.isFloatedButtons){setTimeout(function(){b.topOffset=null;b.initButtonsOffsetTop()},1000);b.initButtonsOffsetTop();$(window).on("scroll",function(){b.positionizeButtons()}).on("resize orientationchange",function(){b.initButtonsOffsetTop(true);b.positionizeButtons()});$(document).on("touchmove",function(){b.positionizeButtons()})}},initButtonsOffsetTop:function(a){var b=this;if(b.topOffset===null||a){b.topOffset=b.buttonsEl.css("bottom",false).removeClass("floated-buttons").offset().top+b.buttonsEl.outerHeight(true)}b.positionizeButtons()},positionizeButtons:function(){var b=this,c=$(window).scrollTop()+$(window).outerHeight()-b.topOffset+5,a=c<0;if(b.isDebug){b.sizesEl.html("Time: "+Date.now()+"<br>t.buttonsEl.parent().width(): "+Math.floor(b.buttonsEl.parent().width()))}if(a){b.buttonsEl.addClass("floated-buttons")}else{b.buttonsEl.removeClass("floated-buttons")}b.buttonsEl.css("width",Math.floor(b.buttonsEl.parent().width()))}})})();